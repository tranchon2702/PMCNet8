@model SurveyViewModel
@{
    ViewData["Title"] = "Khảo sát khóa học";
}

<section class="content-header">
    <div class="container-fluid">
        <div class="row mb-2">
            <div class="col-sm-6">
                <h1>Khảo sát</h1>
            </div>
        </div>
    </div>
</section>
<section class="content">
    <div class="container-fluid">
        <div class="card">
            <div class="card-body">
                <div class="row align-items-end">
                    <div class="col-md-4">
                        <div class="form-group">
                            <label for="courseSelect">Chọn khóa học</label>
                            @if (ViewBag.Courses != null && ((List<SelectListItem>)ViewBag.Courses).Count > 0)
                            {
                                <select id="courseSelect" class="form-control">
                                    @foreach (var course in ViewBag.Courses)
                                    {
                                        <option value="@course.Value">@course.Text</option>
                                    }
                                </select>
                            }
                            else
                            {
                                <p class="text-danger">@(ViewBag.ErrorMessage ?? "Không có khóa học nào được tìm thấy.")</p>
                            }
                        </div>
                    </div>
                    <div class="col-md-2">
                        <div class="form-group">
                            <label for="surveyTypeSelect">Loại khảo sát</label>
                            <select id="surveyTypeSelect" class="form-control">
                                <option value="0">Trước khóa học</option>
                                <option value="1">Sau khóa học</option>
                            </select>
                        </div>
                    </div>
                    <div class="col-md-2">
                        <div class="form-group">
                            <label for="startDate">Từ ngày</label>
                            <input type="text" id="startDate" class="form-control flatpickr" placeholder="dd/mm/yyyy">
                        </div>
                    </div>
                    <div class="col-md-2">
                        <div class="form-group">
                            <label for="endDate">Đến ngày</label>
                            <input type="text" id="endDate" class="form-control flatpickr" placeholder="dd/mm/yyyy">
                        </div>
                    </div>
                    <div class="col-md-2">
                        <button id="viewButton" class="btn btn-primary btn-block">Xem</button>
                    </div>
                </div>
            </div>
        </div>

        <div id="CourseSurvey">@await Html.PartialAsync("_CourseSurvey", Model)</div>
    </div>
</section>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script src="https://cdn.datatables.net/1.11.3/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.4/xlsx.full.min.js"></script>
    <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>

    <script type="text/javascript">
        $(function () {
            google.charts.load('current', { 'packages': ['corechart'] });
            google.charts.setOnLoadCallback(initializePage);
        });

        function initializePage() {
            $('#courseSelect, #surveyTypeSelect').select2();
            flatpickr(".flatpickr", {
                dateFormat: "d/m/Y",
                allowInput: true,
                locale: "vn"
            });
            $('#viewButton').click(loadSurveyData);
        }

        function loadSurveyData() {
            var courseId = $('#courseSelect').val();
            var surveyType = $('#surveyTypeSelect').val();
            var startDate = $('#startDate').val();
            var endDate = $('#endDate').val();

            if (!courseId || surveyType === undefined || !startDate || !endDate) {
                alert('Vui lòng điền đầy đủ thông tin trước khi xem khảo sát.');
                return;
            }

            $.ajax({
                url: '/CourseSurvey/GetSurveyData',
                type: 'GET',
                data: {
                    courseId: courseId,
                    surveyType: surveyType,
                    startDate: startDate,
                    endDate: endDate
                },
                success: function (data) {
                    if (data.includes("Không có dữ liệu khảo sát.")) {
                        Swal.fire({
                            title: 'Thông báo',
                            text: 'Khóa học này không có khảo sát.',
                            icon: 'info',
                            confirmButtonText: 'OK'
                        });
                    } else {
                        $('#CourseSurvey').html(data);
                        setTimeout(function () {
                            initializeCharts();
                            initializeDataTables();
                        }, 100);
                    }
                },
                error: function (xhr, status, error) {
                    console.error('Lỗi khi tải dữ liệu khảo sát:', error);
                    Swal.fire({
                        title: 'Lỗi',
                        text: 'Có lỗi xảy ra khi tải dữ liệu khảo sát. Vui lòng thử lại sau.',
                        icon: 'error',
                        confirmButtonText: 'OK'
                    });
                }
            });
        }

        function initializeCharts() {
            console.log("Initializing charts");
            $('.pie-chart').each(function (index, element) {
                console.log("Drawing pie chart");
                drawPieChart($(element).data('question'), element);
            });

            $('.rating-bars').each(function (index, element) {
                console.log("Updating rating bars");
                updateRatingBars($(element).data('question'), element);
            });
        }

        function drawPieChart(question, element) {
            var data = new google.visualization.DataTable();
            data.addColumn('string', 'Lựa chọn');
            data.addColumn('number', 'Phần trăm');

            var statistics = question.statistics.split(', ');
            statistics.forEach(function (stat) {
                var parts = stat.split(': ');
                var option = parts[0];
                var percentage = parseFloat(parts[1]);
                data.addRow([option, percentage]);
            });

            var options = {
                legend: 'right',
                is3D: true,
                pieSliceText: 'percentage',
                slices: {
                    0: { color: '#4CAF50' },
                    1: { color: '#2196F3' },
                    2: { color: '#FFC107' },
                    3: { color: '#F44336' }
                }
            };

            var chart = new google.visualization.PieChart(element);
            chart.draw(data, options);
        }

        function updateRatingBars(question, element) {
            console.log("updateRatingBars called with:", question);
            var html = '';
            var statistics = question.statistics.split(', ');

            // Sắp xếp thống kê theo số sao giảm dần
            statistics.sort((a, b) => {
                return parseInt(b.split(' ')[0]) - parseInt(a.split(' ')[0]);
            });

            statistics.forEach(function (stat) {
                var parts = stat.split(': ');
                var stars = parseInt(parts[0].split(' ')[0]);
                var percentage = parseFloat(parts[1]);

                html += `
                    <div class="rating-bar d-flex align-items-center mb-2">
                        <div class="stars mr-2" style="min-width: 60px;">
                            ${'★'.repeat(stars)}${'☆'.repeat(5 - stars)}
                        </div>
                        <div class="progress flex-grow-1" style="height: 20px;">
                            <div class="progress-bar bg-primary" role="progressbar"
                                 style="width: ${percentage}%;"
                                 aria-valuenow="${percentage}" aria-valuemin="0" aria-valuemax="100">
                            </div>
                        </div>
                        <div class="percent ml-2" style="min-width: 40px;">${percentage}%</div>
                    </div>
                `;
            });

            $(element).html(html);
        }

        function initializeDataTables() {
            console.log("Initializing DataTables");
            $('.survey-data-table').each(function () {
                if ($.fn.DataTable.isDataTable(this)) {
                    $(this).DataTable().destroy();
                }
                $(this).DataTable({
                    "paging": true,
                    "lengthChange": true,
                    "searching": true,
                    "ordering": true,
                    "info": true,
                    "autoWidth": false,
                    "responsive": true,
                    "language": {
                        "zeroRecords": "Không tìm thấy dữ liệu",
                        "info": "Hiển thị trang _PAGE_ / _PAGES_",
                        "infoEmpty": "Không có dữ liệu",
                        "infoFiltered": "(lọc từ _MAX_ dòng)",
                        "search": "Tìm kiếm:",
                        "paginate": {
                            "first": "Đầu",
                            "last": "Cuối",
                            "next": "Tiếp",
                            "previous": "Trước"
                        }
                    }
                });
            });
        }
        $(document).ready(function () {
            $('#logoutButton').click(function (e) {
                e.preventDefault();
                $.ajax({
                    url: '@Url.Action("Logout", "Account")',
                    type: 'POST',
                    success: function (result) {
                        if (result.success) {
                            window.location.href = result.redirectUrl;
                        } else {
                            console.log('Logout failed');
                        }
                    },
                    error: function (error) {
                        console.log('Logout error:', error);
                    }
                });
            });
        });

    </script>
}